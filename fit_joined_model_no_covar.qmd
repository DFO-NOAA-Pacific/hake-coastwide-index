---
title: "Coastwide index of Pacific hake"
author: "Kelli Johnson, Eric Ward"
format: pdf
editor: visual
---

## Data

We are going to pull data from the `surveyjoin` package. We will restrict the data to just PBS and NWFSC samples, because the AFSC occurrences are so sparse.

```{r}
library(surveyjoin)
library(sdmTMB)
library(tidyr)
library(dplyr)
d <- d <- get_data(common = "north pacific hake", regions = c("pbs", "nwfsc"), years = 2003:2023) |>
as.data.frame()

table(d$year, d$region)

saveRDS(d, "data_for_modelling.rds")
```

## Data cleaning

The first step is to generate a mesh over the PBS / NWFSC sampling domain. The cutoff distance of 15 translates into \~ 880 knots.

```{r}
library(sdmTMB)
d <- dplyr::mutate(d, 
                   lon_mid = (lon_start + lon_end)/2,
                   lat_mid = (lat_start + lat_end)/2) |>
  dplyr::filter(!is.na(lon_mid), !is.na(lat_mid))
d <- add_utm_columns(d, ll_names = c("lon_mid","lat_mid"))

mesh <- make_mesh(d, xy_cols = c("X","Y"), cutoff=15)

mesh$mesh$n

```

```{r}
d$cpue <- d$catch_weight/d$effort
d$fyear <- as.factor(d$year)

```

## Statistical model

Because of the PBS checkerboard sampling pattern, we need to include RW/AR spatiotemporal terms or time as a random walk. As a first model, we'll try fixed year effects and AR(1) spatiotemporal fields

```{r}

fit <- sdmTMB(cpue ~ 0 + fyear,
              spatial="on",
              spatiotemporal = "AR1",
              mesh = mesh,
              data = d,
              time = "year",
              family = delta_gamma())
sanity(fit) # passes all
```

## Predictions

We can extract the survey grids from the surveyjoin package for this:

```{r}
grid <- rbind(surveyjoin::nwfsc_grid,
surveyjoin::dfo_synoptic_grid) |>
  dplyr::select(-survey_domain_year)
years <- unique(d$year)
# create a combination of grid and years
expanded_grid <- crossing(grid, year = years)
expanded_grid$fyear <- as.factor(expanded_grid$year)

# add UTM -- this is UTM zone 10 / 32610
expanded_grid <- add_utm_columns(expanded_grid, ll_names = c("lon","lat"), utm_crs = get_crs(d, ll_names = c("lon_mid","lat_mid")))
```

Now make predictions to the PBS - NWFSC grid

```{r}
predictions <- predict(fit, newdata = expanded_grid, return_tmb_object = TRUE)
index <- get_index(predictions, area = expanded_grid$area, bias_correct = TRUE)
```

## Index

```         
index <- get_index(predictions, area = expanded_grid$area, bias_correct = TRUE)
```
